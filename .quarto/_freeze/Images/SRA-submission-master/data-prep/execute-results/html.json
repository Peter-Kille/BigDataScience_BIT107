{
  "hash": "18edd35d8df4cd0a597d1353f540decc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"R Notebook\"\noutput: html_notebook\neditor_options: \n  chunk_output_type: inline\n---\n\n\n\n\n\nPrepping data to add to SRA\n\n\n\n\n\n\n\n# Import the template\n\nThe first 11 rows are instructions\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemplate <- read_tsv(\"Model.organism.animal.1.0.tsv\", skip = 11)\n```\n:::\n\n\n\n# Import the data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nligation_ids <- read_genepop(\"~/Documents/genomics_pinskylab/data/seq33_03_baits_only_SNPs.gen\") %>% \n  # choose only the names column\n  select(sample) %>% \n  # remove APCL_ from the ligation_id\n  mutate(ligation_id = str_extract(sample, \"L\\\\d+\")) %>% \n  # remove the names column\n  select(-sample)\n\n# bring in fish data from database\nfish <- fish_anem_dive() %>% \n  filter(!is.na(sample_id)) %>% \n  select(sample_id, sex, date)\n\n#what are the sample_ids for these ligation_ids\nsample_ids <- samp_from_lig(ligation_ids) %>% \n  rename(sample_name = sample_id) %>% \n  # Add the organism\n  mutate(organism = \"Amphiprion clarkii\", \n         isolate = \"not applicable\", \n         tissue = \"tail fin\") %>% \n  left_join(fish, by = c(\"sample_name\" = \"sample_id\")) %>% \n  rename(collection_date = date)\n```\n:::\n\n\n\n# SRA did not like repeat sample_ids. Removing sample_ids and keeping only ligation ids\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlig_only <- sample_ids %>% \n  select(-sample_name) %>% \n  rename(sample_name = ligation_id)\n```\n:::\n\n\n\n# Apparently there are also duplicate ligation_ids\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndups <- sample_ids %>% \n  group_by(ligation_id) %>% \n  count() %>% \n  filter(n > 1)\n```\n:::\n\n\n\n# According to this code, there are not duplicates. However, the wording looks like maybe they want unique individuals, as in individuals that were not collected on the same day.\n\n\"Your table upload failed because multiple BioSamples cannot have identical attributes. You should have one BioSample for each specimen, and each of your BioSamples must have differentiating information (excluding sample name, title, bioproject accession and description). This check was implemented to encourage submitters to include distinguishing information in their samples. If the distinguishing information is in the sample name, title or description, please recode it into an appropriate attribute, either one of the predefined attributes or a custom attribute you define. If it is necessary to represent true biological replicates as separate BioSamples, you might add an 'aliquot' or 'replicate' attribute, e.g., 'replicate = biological replicate 1', as appropriate. Note that multiple assay types, e.g., RNA-seq and ChIP-seq data may reference the same BioSample if appropriate.\" \\# To get past this, I am going to include ligation_id in sample name and also include a column called ligation_id (a custom attribute).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamp_lig <- sample_ids %>% \n  mutate(sample_name = str_c(sample_name, ligation_id, sep = \"_\"))\n```\n:::\n\n\n\n# SRA requires that we change M to male and F to female and that we define age, development stage\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamp_lig <- samp_lig %>% \n  mutate(sex = ifelse(sex == \"M\", \"male\", sex), \n         sex = ifelse(sex == \"F\", \"female\", sex), \n         sex = ifelse(sex == \"J\", \"not applicable\", sex), \n         dev_stage = ifelse(sex == \"not applicable\", \"juvenile\", NA),\n         dev_stage = ifelse(sex != \"not applicable\", \"adult\", dev_stage)) %>% \n  # remove any non_apcl samples\n  filter(grepl(\"APCL\", sample_name)) %>% \n  arrange(ligation_id)\n```\n:::\n\n\n\n# SRA requires that these files are 1000 lines or less\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable1 <- samp_lig %>% \n  slice(1:999)\ntable2 <- samp_lig %>% \n  slice(1000:1998)\ntable3 <- samp_lig %>% \n  slice(1998:2881)\n```\n:::\n\n\n\n# Export the data in tab delimited format\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_tsv(table1, \"amphiprion-clarkii-table1.tsv\")\nwrite_tsv(table2, \"amphiprion-clarkii-table2.tsv\")\nwrite_tsv(table3, \"amphiprion-clarkii-table3.tsv\")\n```\n:::\n\n\n\n# Log on to <https://submit.ncbi.nlm.nih.gov/subs/sra/SUB4607463/attributes> and upload the table, then hit continue.\n\n# The next step is to add metadata\n\nView the SRA_metadata_PADE.xlsx file in excel\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# template2 <- readxl::read_xlsx(\"SRA_metadata_PADE.xlsx\")\n```\n:::\n\n\n\nSome samples have a different name and need to be replaced\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# open the list of files that have weird names\nreplacements <- read_lines(\"list.txt\") %>% \n  str_extract(., \"APCL_L\\\\d+.F-RG.bam\") %>% \n  tibble() %>% \n  rename(sample = \".\") %>% \n  mutate(replace = str_c(str_extract(.,\"APCL_L\\\\d+\"), \"-RG.bam\"))\n```\n:::\n\n\n\n# create table for clarkii data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata <- samp_lig %>% \n  rename(library_ID = ligation_id) %>% \n  mutate(title = \"ddRADseq of Amphiprion clarkii\", \n         library_strategy = \"RAD-Seq\", \n         library_source = \"GENOMIC\", \n         library_selection = \"Reduced Representation\", \n         library_layout = \"single\", \n         platform = \"Illumina\", \n         instrument_model = \"Illumina HiSeq 2500\", \n         design_description = \"ddRADseq using PstI and MluCI, and size selected to 375 ± 38 bp\", \n         filetype = \"bam\", \n         filename = str_c(\"APCL_\", library_ID, \"-RG.bam\", sep = \"\"), \n         assembly = NA\n         ) %>%\n  select(-organism:-dev_stage) %>% \n  # fix names of regeno files\n  mutate(filename = ifelse(filename == \"APCL_L0306-RG.bam\", \"APCL_L0306.L3598-RG.bam\", filename), \n          filename = ifelse(filename == \"APCL_L0308-RG.bam\", \"APCL_L0308.L3599-RG.bam\", filename),\n         filename = ifelse(filename == \"APCL_L0309-RG.bam\", \"APCL_L0309.L3601-RG.bam\", filename),\n         filename = ifelse(filename == \"APCL_L0814-RG.bam\", \"APCL_L0814.L3644-RG.bam\", filename),\n         filename = ifelse(filename == \"APCL_L1188-RG.bam\", \"APCL_L1188.L3266.L3352-RG.bam\", filename),\n         filename = ifelse(filename == \"APCL_L2324-RG.bam\", \"APCL_L2324.L3400-RG.bam\", filename)) %>% \n  mutate(filename = ifelse(filename %in% replacements$replace, str_c(\"APCL_\", library_ID, \"-RG.bam\"), filename))\n```\n:::\n\n\n\n# SRA requires that these files are 1000 lines or less\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata1 <- metadata %>% \n  slice(1:999)\nmetadata2 <- metadata %>% \n  slice(1000:1998)\nmetadata3 <- metadata %>% \n  slice(1998:2886)\n```\n:::\n\n\n\n# Export the meta data tables\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_tsv(metadata1, \"amphiprion-clarkii-metadata1.tsv\")\nwrite_tsv(metadata2, \"amphiprion-clarkii-metadata2.tsv\")\nwrite_tsv(metadata3, \"amphiprion-clarkii-metadata3.tsv\")\n```\n:::\n\n\n\n# Sending the bam files by FTP - COMPRESS Folder INTO TAR!!!\n\nI logged into the FTP using Fetch following the onscreen instructions and started dragging over bam files.\\\nHowever, the bam.bai files are also intertwined, it was taking hours, and was timing out before completing all of the transfers.\\\nI copied all of the bam files into a bam files folder in the data \\> apcl \\> all_samples \\> 20181127 \\> bam files.\\\nMaybe I can separate them into folders on my end and then just drag and drop the folder for submission. The folder transfer will take hours but hopefully it won't time out.\n\n# The file names don't match the metadata\n\nhand edit the metadata table because it is just a few regenotypes\n\n# The first submission is called SUB4607463\n\nThere is an error of undefined origin, waiting for an email response\n\n# The second submission is called SUB6249894\n\n-   Mark no for biosample\n-   upload table_2 for biosample attributes\n-   transferring files starting 11:20am on Monday, 9-9-2019\n\n\n\n::: {.cell}\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}